#property copyright "Copyright 2025, Dubravaspb"
#property link      "https://www.mql5.com"
#property version   "1.01"
#property description "Advanced implementation of Dubravaspb's Volume Flow Indicator with comprehensive analysis tools featuring buy/sell signals with customizable parameters, pattern recognition, real-time risk assessment, dynamic zones, trend analysis, multilingual interface, and customizable alerts - perfect for incorporating volume analysis into any trading strategy with powerful confirmation tools."
#property indicator_separate_window
#property indicator_buffers 11
#property indicator_plots   9

//--- plot VFI
#property indicator_label1  "VFI"
#property indicator_type1   DRAW_LINE
#property indicator_color1  clrGreen
#property indicator_style1  STYLE_SOLID
#property indicator_width1  2

//--- plot VFI EMA
#property indicator_label2  "EMA of VFI"
#property indicator_type2   DRAW_LINE
#property indicator_color2  clrOrange
#property indicator_style2  STYLE_SOLID
#property indicator_width2  1

//--- plot Histogram
#property indicator_label3  "Histogram"
#property indicator_type3   DRAW_HISTOGRAM
#property indicator_color3  clrGray
#property indicator_style3  STYLE_SOLID
#property indicator_width3  3

//--- plot Buy Signal
#property indicator_label4  "Buy Signal"
#property indicator_type4   DRAW_ARROW
#property indicator_color4  clrLime
#property indicator_style4  STYLE_SOLID
#property indicator_width4  2

//--- plot Sell Signal
#property indicator_label5  "Sell Signal"
#property indicator_type5   DRAW_ARROW
#property indicator_color5  clrRed
#property indicator_style5  STYLE_SOLID
#property indicator_width5  2

//--- plot Risk Level
#property indicator_label9  "Risk Level"
#property indicator_type9   DRAW_COLOR_HISTOGRAM
#property indicator_color9  clrGreen, clrYellow, clrRed
#property indicator_style9  STYLE_SOLID
#property indicator_width9  2

//--- input parameters
input int      VFI_Length = 130;        // VFI length
input double   Coef = 0.2;              // Coefficient
input double   VCoef = 2.5;             // Max. vol. cutoff
input int      SignalLength = 5;        // Signal length
input bool     SmoothVFI = false;       // Smooth VFI
input bool     ShowHisto = false;       // Show Histogram
input bool     UseRealVolume = false;   // Use Real Volume (if available)
input bool     ShowPatterns = true;     // Enable Pattern Detection (now for display only)
input bool     EnableAlerts = true;     // Enable Sound Alerts
input bool     EnableNotifications = false; // Enable Push Notifications
input bool     EnableDynamicColors = true;  // Enable Dynamic Colors

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–µ–Ω–¥–∞ –∏ –∑–æ–Ω –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
input int      TrendPeriod = 20;        // The period for determining the trend
input int      TrendSmoothingPeriod = 5; // Smoothing period to determine the trend
input int      ZonesAutoCalculationPeriod = 200; // The period for automatic zone calculation
input double   ZonePercentile = 80.0;   // Percentile for zones (80% = upper/lower 20%)
input color    OverboughtColor = clrRed; // The color of the overbought zone
input color    OversoldColor = clrGreen; // Oversold zone color
input int      ZoneTransparency = 80;   // Transparency of zones (0-255, where 0=transparent, 255=opaque)

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏
input bool     ShowInfoPanel = true;    // Show Information Panel
input ENUM_BASE_CORNER InfoPanelCorner = CORNER_LEFT_UPPER; // Info Panel Corner
input int      InfoPanelX = 10;         // Info Panel X Distance
input int      InfoPanelY = 10;         // Info Panel Y Distance
input int      InfoPanelWidth = 200;    // Info Panel Width
input int      InfoPanelHeight = 140;   // Info Panel Height (—É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª—è —Ç—Ä–µ–Ω–¥–∞)
input color    InfoPanelColor = clrDarkBlue; // Info Panel Background Color
input color    InfoPanelTextColor = clrWhite; // Info Panel Text Color

input int      RiskAssessmentPeriod = 14;   // Risk Assessment Period

//--- indicator buffers
double VFI_Buffer[];
double VFI_EMA_Buffer[];
double Histogram_Buffer[];
double VCP_Buffer[];
double Buy_Signal_Buffer[];
double Sell_Signal_Buffer[];
double DoubleBottom_Buffer[];
double DoubleTop_Buffer[];
double Divergence_Buffer[];
double Risk_Buffer[];
double Risk_Colors_Buffer[];

//--- arrays for calculations
double inter_array[];
double typical_array[];
double volatility_array[];
double price_array[];
double trend_buffer[];         // –ë—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–µ–Ω–¥–µ

//--- global variables
bool real_volumes_available = false;
bool is_russian_system = false;
int last_calculated = 0; // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞
datetime last_alert_time = 0;
int alert_delay = 300; // 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –∞–ª–µ—Ä—Ç–∞–º–∏
datetime indicator_load_time = 0;  // –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ - –î–û–ë–ê–í–õ–ï–ù–û

// –î–ª—è –º–∏–Ω–∏-–¥–∏—Å–ø–ª–µ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
string info_panel_id = "VFI_InfoPanel";
string pattern_text_id = "VFI_PatternText";
string datetime_text_id = "VFI_DatetimeText";
string username_text_id = "VFI_UsernameText";
string risk_text_id = "VFI_RiskText";
string trend_text_id = "VFI_TrendText";    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
string zones_text_id = "VFI_ZonesText";    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –∑–æ–Ω
datetime last_update_time = 0;
int update_frequency = 5; // –û–±–Ω–æ–≤–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
double dynamic_overbought_level = 0;
double dynamic_oversold_level = 0;
datetime last_zone_calculation = 0;
int zone_calculation_delay = 300; // 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –ø–µ—Ä–µ—Å—á–µ—Ç–∞–º–∏

// –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –æ–±—ä–µ–∫—Ç–æ–≤ –∑–æ–Ω
string overbought_zone_id = "VFI_Overbought_Zone";
string oversold_zone_id = "VFI_Oversold_Zone";
string overbought_line_id = "VFI_Overbought_Line";
string oversold_line_id = "VFI_Oversold_Line";

// Enum –¥–ª—è —É—Ä–æ–≤–Ω–µ–π —Ä–∏—Å–∫–∞
enum ENUM_RISK_LEVEL
{
    RISK_LOW = 0,    // –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ (–∑–µ–ª–µ–Ω—ã–π)
    RISK_MEDIUM = 1, // –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ (–∂–µ–ª—Ç—ã–π)
    RISK_HIGH = 2    // –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ (–∫—Ä–∞—Å–Ω—ã–π)
};

// Enum –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
enum ENUM_TREND_DIRECTION
{
    TREND_UP = 1,       // –í–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥
    TREND_DOWN = -1,    // –ù–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥
    TREND_SIDEWAYS = 0  // –ë–æ–∫–æ–≤–æ–π —Ç—Ä–µ–Ω–¥
};

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
datetime session_start_time = 0;

//+------------------------------------------------------------------+
//| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ —Å–∏—Å—Ç–µ–º—ã                                       |
//+------------------------------------------------------------------+
bool IsRussianSystem()
{
    // –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    string terminal_language = TerminalInfoString(TERMINAL_LANGUAGE);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —è–∑—ã–∫ —Ä—É—Å—Å–∫–∏–º
    if(terminal_language == "Russian" || terminal_language == "–†—É—Å—Å–∫–∏–π" || 
       StringFind(terminal_language, "RU") >= 0 || StringFind(terminal_language, "ru") >= 0)
    {
        return true;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é —á–∏—Å–µ–ª
    string test_number = DoubleToString(1.5, 1);
    if(StringFind(test_number, ",") >= 0) // –í —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å - –∑–∞–ø—è—Ç–∞—è
    {
        return true;
    }
    
    return false;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞                                |
//+------------------------------------------------------------------+
string GetLocalizedText(string key)
{
    if(!is_russian_system)
    {
        // English texts
        if(key == "volume_check_header") return "           VFI INDICATOR VOLUME CHECK           ";
        if(key == "symbol") return "Symbol";
        if(key == "datetime") return "Date/time";
        if(key == "user") return "User";
        if(key == "execution_type") return "Execution type";
        if(key == "terminal_paths") return "DEBUG - Terminal paths";
        if(key == "bars_analyzed") return "Bars analyzed";
        if(key == "tick_volumes") return "TICK VOLUMES";
        if(key == "average") return "Average";
        if(key == "maximum") return "Maximum";
        if(key == "minimum") return "Minimum";
        if(key == "zero_bars") return "Bars with zero volume";
        if(key == "real_volumes") return "REAL VOLUMES";
        if(key == "real_volumes_unavailable") return "REAL VOLUMES: Unavailable";
        if(key == "quality_assessment") return "QUALITY ASSESSMENT";
        if(key == "recommendation") return "RECOMMENDATION";
        if(key == "indicator_settings") return "INDICATOR SETTINGS";
        if(key == "will_use_real") return "Will use: REAL VOLUMES";
        if(key == "will_use_tick") return "Will use: TICK VOLUMES";
        if(key == "yes") return "YES";
        if(key == "no") return "NO";
        if(key == "error_no_data") return "‚ùå ERROR: Could not get price data!";
        if(key == "critical_no_volumes") return "‚ùå CRITICAL: Very little volume data";
        if(key == "poor_no_variation") return "‚ö†Ô∏è POOR: Volumes hardly change";
        if(key == "satisfactory_tick_only") return "‚ö†Ô∏è SATISFACTORY: Tick volumes only";
        if(key == "excellent_real_volumes") return " EXCELLENT: Quality real volumes";
        if(key == "good_real_gaps") return " GOOD: Real volumes with gaps";
        if(key == "change_instrument") return "Change instrument or broker";
        if(key == "may_work_incorrectly") return "Indicator may work incorrectly";
        if(key == "will_work_less_accurate") return "Indicator will work, but less accurately";
        if(key == "will_work_max_accurate") return "Indicator will work with maximum accuracy";
        if(key == "will_work_correctly") return "Indicator will work correctly";
        if(key == "indicator_finished") return "         VFI INDICATOR FINISHED WORK         ";
        if(key == "reason") return "Reason";
        if(key == "time") return "Time";
        if(key == "parameter_error") return "Parameter Error";
        if(key == "invalid_vfi_length") return "VFI_Length must be >= 10";
        if(key == "invalid_signal_length") return "SignalLength must be >= 1";
        if(key == "invalid_coefficients") return "Coefficients must be positive";
        if(key == "settings_changed") return "Settings changed - recalculating all data";
        if(key == "buy_signals_enabled") return "Buy signals enabled";
        if(key == "sell_signals_enabled") return "Sell signals enabled";
        if(key == "pattern_recognition_enabled") return "Pattern recognition enabled";
        if(key == "alerts_enabled") return "Alerts enabled";
        if(key == "notifications_enabled") return "Push notifications enabled";
        if(key == "dynamic_colors_enabled") return "Dynamic colors enabled";
        if(key == "info_panel_enabled") return "Information panel enabled";
        if(key == "buy_signal_detected") return "VFI Buy Signal detected";
        if(key == "sell_signal_detected") return "VFI Sell Signal detected";
        if(key == "double_bottom_detected") return "Double Bottom pattern detected";
        if(key == "double_top_detected") return "Double Top pattern detected";
        if(key == "divergence_detected") return "Divergence pattern detected";
        if(key == "risk_assessment") return "Risk Level";
        if(key == "risk_low") return "Low";
        if(key == "risk_medium") return "Medium";
        if(key == "risk_high") return "High";
        if(key == "current_user") return "Current User";
        if(key == "current_time") return "Current Time";
        if(key == "detected_patterns") return "Detected Patterns";
        if(key == "no_patterns_detected") return "No patterns detected";
        if(key == "panel_title") return "VFI Info Panel";
        // –¢–µ–∫—Å—Ç—ã –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
        if(key == "trend") return "Trend";
        if(key == "trend_up") return "Uptrend";
        if(key == "trend_down") return "Downtrend";
        if(key == "trend_sideways") return "Sideways";
        if(key == "trend_strength") return "Strength";
        if(key == "overbought_zones") return "Overbought zones enabled";
        if(key == "oversold_zones") return "Oversold zones enabled";
        // –¢–µ–∫—Å—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω
        if(key == "auto_zones") return "Auto zones calculation enabled";
        if(key == "overbought_level") return "Overbought level";
        if(key == "oversold_level") return "Oversold level";
        if(key == "zones") return "Zones";
        if(key == "recalculating_zones") return "Recalculating zone levels";
        // –¢–µ–∫—Å—Ç—ã –¥–ª—è —Å–µ—Å—Å–∏–∏
        if(key == "minutes") return "min";
        if(key == "hours") return "h";
        if(key == "days") return "d";
    }
    else
    {
        // Russian texts
        if(key == "volume_check_header") return "           –ü–†–û–í–ï–†–ö–ê –û–ë–™–ï–ú–û–í VFI –ò–ù–î–ò–ö–ê–¢–û–†–ê           ";
        if(key == "symbol") return "–°–∏–º–≤–æ–ª";
        if(key == "datetime") return "–î–∞—Ç–∞/–≤—Ä–µ–º—è";
        if(key == "user") return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        if(key == "execution_type") return "–¢–∏–ø –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è";
        if(key == "terminal_paths") return "DEBUG - –ü—É—Ç–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞";
        if(key == "bars_analyzed") return "–ü–æ–ª—É—á–µ–Ω–æ –±–∞—Ä–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞";
        if(key == "tick_volumes") return "–¢–ò–ö–û–í–´–ï –û–ë–™–ï–ú–´";
        if(key == "average") return "–°—Ä–µ–¥–Ω–∏–π";
        if(key == "maximum") return "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π";
        if(key == "minimum") return "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π";
        if(key == "zero_bars") return "–ë–∞—Ä–æ–≤ —Å –Ω—É–ª–µ–≤—ã–º –æ–±—ä–µ–º–æ–º";
        if(key == "real_volumes") return "–†–ï–ê–õ–¨–ù–´–ï –û–ë–™–ï–ú–´";
        if(key == "real_volumes_unavailable") return "–†–ï–ê–õ–¨–ù–´–ï –û–ë–™–ï–ú–´: –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã";
        if(key == "quality_assessment") return "–û–¶–ï–ù–ö–ê –ö–ê–ß–ï–°–¢–í–ê";
        if(key == "recommendation") return "–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø";
        if(key == "indicator_settings") return "–ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–ê";
        if(key == "will_use_real") return "–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã: –†–ï–ê–õ–¨–ù–´–ï –û–ë–™–ï–ú–´";
        if(key == "will_use_tick") return "–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã: –¢–ò–ö–û–í–´–ï –û–ë–™–ï–ú–´";
        if(key == "yes") return "–î–ê";
        if(key == "no") return "–ù–ï–¢";
        if(key == "error_no_data") return "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —Ü–µ–Ω–∞–º!";
        if(key == "critical_no_volumes") return "‚ùå –ö–†–ò–¢–ò–ß–ù–û: –û—á–µ–Ω—å –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±—ä–µ–º–∞–º";
        if(key == "poor_no_variation") return "‚ö†Ô∏è –ü–õ–û–•–û: –û–±—ä–µ–º—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è";
        if(key == "satisfactory_tick_only") return "‚ö†Ô∏è –£–î–û–í–õ–ï–¢–í–û–†–ò–¢–ï–õ–¨–ù–û: –¢–æ–ª—å–∫–æ —Ç–∏–∫–æ–≤—ã–µ –æ–±—ä–µ–º—ã";
        if(key == "excellent_real_volumes") return " –û–¢–õ–ò–ß–ù–û: –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–º—ã";
        if(key == "good_real_gaps") return " –•–û–†–û–®–û: –†–µ–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–º—ã —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏";
        if(key == "change_instrument") return "–°–º–µ–Ω–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–ª–∏ –±—Ä–æ–∫–µ—Ä–∞";
        if(key == "may_work_incorrectly") return "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ";
        if(key == "will_work_less_accurate") return "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ";
        if(key == "will_work_max_accurate") return "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ";
        if(key == "will_work_correctly") return "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ";
        if(key == "indicator_finished") return "         VFI –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–í–ï–†–®–ò–õ –†–ê–ë–û–¢–£         ";
        if(key == "reason") return "–ü—Ä–∏—á–∏–Ω–∞";
        if(key == "time") return "–í—Ä–µ–º—è";
        if(key == "parameter_error") return "–û—à–∏–±–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤";
        if(key == "invalid_vfi_length") return "VFI_Length –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 10";
        if(key == "invalid_signal_length") return "SignalLength –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 1";
        if(key == "invalid_coefficients") return "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏";
        if(key == "settings_changed") return "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–º–µ–Ω–µ–Ω—ã - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ";
        if(key == "buy_signals_enabled") return "–°–∏–≥–Ω–∞–ª—ã –ø–æ–∫—É–ø–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã";
        if(key == "sell_signals_enabled") return "–°–∏–≥–Ω–∞–ª—ã –ø—Ä–æ–¥–∞–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã";
        if(key == "pattern_recognition_enabled") return "–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ";
        if(key == "alerts_enabled") return "–ó–≤—É–∫–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã";
        if(key == "notifications_enabled") return "Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã";
        if(key == "dynamic_colors_enabled") return "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞ –≤–∫–ª—é—á–µ–Ω—ã";
        if(key == "info_panel_enabled") return "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –≤–∫–ª—é—á–µ–Ω–∞";
        if(key == "buy_signal_detected") return "–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–∏–≥–Ω–∞–ª –ø–æ–∫—É–ø–∫–∏ VFI";
        if(key == "sell_signal_detected") return "–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–æ–¥–∞–∂–∏ VFI";
        if(key == "double_bottom_detected") return "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –î–≤–æ–π–Ω–æ–µ –î–Ω–æ";
        if(key == "double_top_detected") return "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –î–≤–æ–π–Ω–∞—è –í–µ—Ä—à–∏–Ω–∞";
        if(key == "divergence_detected") return "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è";
        if(key == "risk_assessment") return "–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞";
        if(key == "risk_low") return "–ù–∏–∑–∫–∏–π";
        if(key == "risk_medium") return "–°—Ä–µ–¥–Ω–∏–π";
        if(key == "risk_high") return "–í—ã—Å–æ–∫–∏–π";
        if(key == "current_user") return "–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        if(key == "current_time") return "–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è";
        if(key == "detected_patterns") return "–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã";
        if(key == "no_patterns_detected") return "–ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã";
        if(key == "panel_title") return "VFI –ò–Ω—Ñ–æ –ü–∞–Ω–µ–ª—å";
        // –¢–µ–∫—Å—Ç—ã –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
        if(key == "trend") return "–¢—Ä–µ–Ω–¥";
        if(key == "trend_up") return "–í–æ—Å—Ö–æ–¥—è—â–∏–π";
        if(key == "trend_down") return "–ù–∏—Å—Ö–æ–¥—è—â–∏–π";
        if(key == "trend_sideways") return "–ë–æ–∫–æ–≤–æ–π";
        if(key == "trend_strength") return "–°–∏–ª–∞";
        if(key == "overbought_zones") return "–ó–æ–Ω—ã –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á–µ–Ω—ã";
        if(key == "oversold_zones") return "–ó–æ–Ω—ã –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á–µ–Ω—ã";
        // –¢–µ–∫—Å—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω
        if(key == "auto_zones") return "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∑–æ–Ω –≤–∫–ª—é—á–µ–Ω";
        if(key == "overbought_level") return "–£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏";
        if(key == "oversold_level") return "–£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏";
        if(key == "zones") return "–ó–æ–Ω—ã";
        if(key == "recalculating_zones") return "–ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π –∑–æ–Ω";
        // –¢–µ–∫—Å—Ç—ã –¥–ª—è —Å–µ—Å—Å–∏–∏
        if(key == "minutes") return "–º–∏–Ω";
        if(key == "hours") return "—á";
        if(key == "days") return "–¥";
    }
    
    return key;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞                         |
//+------------------------------------------------------------------+
string GetComputerUserName()
{
    string username = "YassAbdelali1"; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    // –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    string data_path = TerminalInfoString(TERMINAL_DATA_PATH);
    
    if(StringLen(data_path) > 0)
    {
        int pos = StringFind(data_path, "Users\\");
        if(pos >= 0)
        {
            int start = pos + 6; // –¥–ª–∏–Ω–∞ "Users\"
            int end = StringFind(data_path, "\\", start);
            if(end > start)
            {
                string extracted = StringSubstr(data_path, start, end - start);
                if(StringLen(extracted) > 0 && extracted != "AppData" && 
                   extracted != "Roaming" && extracted != "MetaQuotes")
                {
                    username = extracted;
                }
            }
        }
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    StringReplace(username, " ", "_");
    if(StringLen(username) > 20)
        username = StringSubstr(username, 0, 20);
    
    return username;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏                                |
//+------------------------------------------------------------------+
string GetCurrentDateTime()
{
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    datetime current_time = TimeGMT(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º GMT –≤—Ä–µ–º—è
    
    MqlDateTime dt;
    TimeToStruct(current_time, dt);
    
    return StringFormat("%04d-%02d-%02d %02d:%02d:%02d", 
                      dt.year, dt.mon, dt.day, dt.hour, dt.min, dt.sec);
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Å—Å–∏–∏                                 |
//+------------------------------------------------------------------+
string GetSessionUptime()
{
    if(session_start_time == 0)
        return "00:00";
    
    datetime current_time = TimeGMT();
    int uptime_seconds = (int)(current_time - session_start_time);
    
    int days = uptime_seconds / 86400;
    uptime_seconds %= 86400;
    int hours = uptime_seconds / 3600;
    uptime_seconds %= 3600;
    int minutes = uptime_seconds / 60;
    
    string uptime_str = "";
    
    if(days > 0)
        uptime_str += IntegerToString(days) + GetLocalizedText("days") + " ";
    if(hours > 0)
        uptime_str += IntegerToString(hours) + GetLocalizedText("hours") + " ";
    
    uptime_str += IntegerToString(minutes) + GetLocalizedText("minutes");
    
    return uptime_str;
}

//+------------------------------------------------------------------+
//| Send Alert Function - –ò–°–ü–†–ê–í–õ–ï–ù–û                                |
//+------------------------------------------------------------------+
void SendAlert(string message, datetime signal_time)
{
    datetime current_time = TimeCurrent();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–ª–µ—Ä—Ç–∞
    if(current_time - last_alert_time < alert_delay)
        return;
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –±–∞—Ä–æ–≤ (–¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞)
    if(signal_time < indicator_load_time)
        return;
        
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–∞
    last_alert_time = current_time;
    
    // –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∂—É—Ä–Ω–∞–ª
    Print(message);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–≤—É–∫–æ–≤–æ–π –∞–ª–µ—Ä—Ç
    if(EnableAlerts)
        Alert(message);
        
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if(EnableNotifications)
        SendNotification(message);
}

//+------------------------------------------------------------------+
//| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —É—Ä–æ–≤–Ω–µ–π –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏  |
//+------------------------------------------------------------------+
void CalculateOverboughtOversoldLevels(int bar_pos)
{
    if(bar_pos < ZonesAutoCalculationPeriod)
        return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —á–∞—Å—Ç–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–æ–Ω—ã
    datetime current_time = TimeCurrent();
    if(current_time - last_zone_calculation < zone_calculation_delay && dynamic_overbought_level != 0)
        return;
        
    last_zone_calculation = current_time;
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–Ω–∞—á–µ–Ω–∏—è–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    double vfi_values[];
    ArrayResize(vfi_values, ZonesAutoCalculationPeriod);
    
    int count = 0;
    for(int i = bar_pos; i > bar_pos - ZonesAutoCalculationPeriod && i >= 0; i--)
    {
        if(VFI_Buffer[i] != EMPTY_VALUE)
        {
            vfi_values[count] = VFI_Buffer[i];
            count++;
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if(count < ZonesAutoCalculationPeriod / 2)
    {
        // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        dynamic_overbought_level = 1.0;
        dynamic_oversold_level = -1.0;
        Print("Warning: Not enough data to calculate zones, using default values");
        return;
    }
    
    // –ü–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞ –ø–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    ArrayResize(vfi_values, count);
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–µ–π
    ArraySort(vfi_values);
    
    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–µ–π
    int upper_pos = (int)((count - 1) * ZonePercentile / 100.0);
    int lower_pos = (int)((count - 1) * (100.0 - ZonePercentile) / 100.0);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤
    if(upper_pos >= count) upper_pos = count - 1;
    if(lower_pos < 0) lower_pos = 0;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–Ω–∏
    dynamic_overbought_level = vfi_values[upper_pos];
    dynamic_oversold_level = vfi_values[lower_pos];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ overbought > oversold
    if(dynamic_overbought_level <= dynamic_oversold_level)
    {
        // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        double sum = 0, sum_sq = 0;
        for(int i = 0; i < count; i++)
        {
            sum += vfi_values[i];
            sum_sq += MathPow(vfi_values[i], 2);
        }
        double mean = sum / count;
        double std_dev = MathSqrt(sum_sq / count - mean * mean);
        
        dynamic_overbought_level = mean + 1.5 * std_dev;
        dynamic_oversold_level = mean - 1.5 * std_dev;
    }
    
    Print("üîÑ ", GetLocalizedText("recalculating_zones"), ": OB=", 
          DoubleToString(dynamic_overbought_level, 4), ", OS=", 
          DoubleToString(dynamic_oversold_level, 4));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –∑–æ–Ω –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    UpdateZoneObjects(bar_pos);
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∑–æ–Ω - –ò–°–ü–†–ê–í–õ–ï–ù–û                           |
//+------------------------------------------------------------------+
void UpdateZoneObjects(int bar_pos)
{
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—ä–µ–∫—Ç—ã –∑–æ–Ω
    ObjectDelete(0, overbought_zone_id);
    ObjectDelete(0, oversold_zone_id);
    ObjectDelete(0, overbought_line_id);
    ObjectDelete(0, oversold_line_id);
    
    // –ï—Å–ª–∏ —É—Ä–æ–≤–Ω–∏ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∏–ª–∏ —Ä–∞–≤–Ω—ã 0, —É—Å—Ç–∞–Ω–æ–≤–∏–º –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    if(dynamic_overbought_level == 0 || dynamic_oversold_level == 0)
    {
        dynamic_overbought_level = 1.0;  // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Ä–æ–≤–Ω—è –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏
        dynamic_oversold_level = -1.0;   // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Ä–æ–≤–Ω—è –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–∫–Ω–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    int window = ChartWindowFind();
    if(window < 0) return;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –∏ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—ã –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∑–æ–Ω
    double chart_max = 0, chart_min = 0;
    ChartGetDouble(0, CHART_PRICE_MAX, window, chart_max);
    ChartGetDouble(0, CHART_PRICE_MIN, window, chart_min);
    
    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –≤—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
    if(chart_max <= 0 || chart_min >= 0)
    {
        chart_max = MathMax(2.0, dynamic_overbought_level * 1.5);
        chart_min = MathMin(-2.0, dynamic_oversold_level * 1.5);
        
        // –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        double max_value = -DBL_MAX;
        double min_value = DBL_MAX;
        
        for(int i = bar_pos; i >= MathMax(0, bar_pos - 500); i--)
        {
            if(VFI_Buffer[i] != EMPTY_VALUE)
            {
                if(VFI_Buffer[i] > max_value) max_value = VFI_Buffer[i];
                if(VFI_Buffer[i] < min_value) min_value = VFI_Buffer[i];
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è –≥—Ä–∞–Ω–∏—Ü
        chart_max = MathMax(chart_max, max_value * 1.2);
        chart_min = MathMin(chart_min, min_value * 1.2);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ–±—ä–µ–∫—Ç–æ–≤
    datetime time_start = iTime(Symbol(), PERIOD_CURRENT, MathMin(bar_pos, 100));
    datetime time_end = TimeCurrent() + 86400; // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—Ç–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–ø—Ä–∞–≤–æ
    
    // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    if(time_start <= 0) time_start = TimeCurrent() - 86400 * 10; // –ú–∏–Ω—É—Å 10 —Å—É—Ç–æ–∫
    if(time_end <= 0) time_end = TimeCurrent() + 86400; // –ü–ª—é—Å —Å—É—Ç–∫–∏
    
    Print("Creating zones at bar pos: ", bar_pos, ", times: ", time_start, " - ", time_end);
    Print("Chart bounds: min=", chart_min, ", max=", chart_max);
    Print("Zone levels: OB=", dynamic_overbought_level, ", OS=", dynamic_oversold_level);
    
    // –°–æ–∑–¥–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π (–¥–ª—è –±–æ–ª–µ–µ —á–µ—Ç–∫–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π)
    if(ObjectCreate(0, overbought_line_id, OBJ_TREND, window, time_start, dynamic_overbought_level, 
                                                         time_end, dynamic_overbought_level))
    {
        ObjectSetInteger(0, overbought_line_id, OBJPROP_COLOR, OverboughtColor);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_STYLE, STYLE_DASH);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_WIDTH, 1);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_RAY_RIGHT, false);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_RAY_LEFT, false);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_BACK, true);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_SELECTED, false);
        ObjectSetInteger(0, overbought_line_id, OBJPROP_HIDDEN, true);
    }
    
    if(ObjectCreate(0, oversold_line_id, OBJ_TREND, window, time_start, dynamic_oversold_level, 
                                                      time_end, dynamic_oversold_level))
    {
        ObjectSetInteger(0, oversold_line_id, OBJPROP_COLOR, OversoldColor);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_STYLE, STYLE_DASH);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_WIDTH, 1);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_RAY_RIGHT, false);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_RAY_LEFT, false);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_BACK, true);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_SELECTED, false);
        ObjectSetInteger(0, oversold_line_id, OBJPROP_HIDDEN, true);
    }
    
    // –°–æ–∑–¥–∞–µ–º –∑–∞–ª–∏–≤–∫—É –∑–æ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OBJ_RECTANGLE
    // –ó–æ–Ω–∞ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏ (–≤–µ—Ä—Ö–Ω—è—è –∑–∞–ª–∏–≤–∫–∞)
    if(ObjectCreate(0, overbought_zone_id, OBJ_RECTANGLE, window, 
                   time_start, dynamic_overbought_level, time_end, chart_max))
    {
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_COLOR, OverboughtColor);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_FILL, true);
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_BGCOLOR, OverboughtColor);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_BACK, true);
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_SELECTED, false);
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_HIDDEN, true);
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_WIDTH, 1);
        ObjectSetInteger(0, overbought_zone_id, OBJPROP_ZORDER, 0); // –ù–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω
    }
    
    // –ó–æ–Ω–∞ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (–Ω–∏–∂–Ω—è—è –∑–∞–ª–∏–≤–∫–∞)
    if(ObjectCreate(0, oversold_zone_id, OBJ_RECTANGLE, window, 
                   time_start, chart_min, time_end, dynamic_oversold_level))
    {
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_COLOR, OversoldColor);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_FILL, true);
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_BGCOLOR, OversoldColor);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_BACK, true);
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_SELECTED, false);
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_HIDDEN, true);
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_WIDTH, 1);
        ObjectSetInteger(0, oversold_zone_id, OBJPROP_ZORDER, 0); // –ù–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω
    }
}

//+------------------------------------------------------------------+
//| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞                                             |
//+------------------------------------------------------------------+
ENUM_TREND_DIRECTION DetermineTrend(int bar_pos, int period, double &strength)
{
    if(bar_pos <= period || ArraySize(VFI_Buffer) <= period)
        return TREND_SIDEWAYS;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ VFI –¥–ª—è –±–æ–ª–µ–µ –≥–ª–∞–¥–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
    double ma_current = 0, ma_previous = 0;
    int valid_bars = 0;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º SMA –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
    for(int i = 0; i < TrendSmoothingPeriod; i++)
    {
        if(bar_pos - i >= 0 && VFI_Buffer[bar_pos - i] != EMPTY_VALUE)
        {
            ma_current += VFI_Buffer[bar_pos - i];
            valid_bars++;
        }
    }
    
    if(valid_bars > 0)
        ma_current /= valid_bars;
    else
        return TREND_SIDEWAYS;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º SMA –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
    valid_bars = 0;
    for(int i = period; i < period + TrendSmoothingPeriod; i++)
    {
        if(bar_pos - i >= 0 && VFI_Buffer[bar_pos - i] != EMPTY_VALUE)
        {
            ma_previous += VFI_Buffer[bar_pos - i];
            valid_bars++;
        }
    }
    
    if(valid_bars > 0)
        ma_previous /= valid_bars;
    else
        return TREND_SIDEWAYS;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞
    double diff = ma_current - ma_previous;
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∏–ª—É —Ç—Ä–µ–Ω–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥
    double max_diff = 0;
    for(int i = 0; i < period; i++)
    {
        if(bar_pos - i >= 0 && bar_pos - i - 1 >= 0)
        {
            double bar_diff = MathAbs(VFI_Buffer[bar_pos - i] - VFI_Buffer[bar_pos - i - 1]);
            if(bar_diff > max_diff)
                max_diff = bar_diff;
        }
    }
    
    // –°–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞ - –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 1
    if(max_diff > 0)
        strength = MathMin(MathAbs(diff) / max_diff, 1.0);
    else
        strength = 0;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–æ–∫–æ–≤–æ–π —Ç—Ä–µ–Ω–¥ –ø—Ä–∏ –º–∞–ª—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    if(MathAbs(diff) < 0.05)
        return TREND_SIDEWAYS;
        
    if(diff > 0)
        return TREND_UP;
    else
        return TREND_DOWN;
}

//+------------------------------------------------------------------+
//| –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏                                  |
//+------------------------------------------------------------------+
void CreateInfoPanel()
{
    if(!ShowInfoPanel)
        return;
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –ø–∞–Ω–µ–ª–∏
    if(ObjectFind(0, info_panel_id) < 0)
    {
        ObjectCreate(0, info_panel_id, OBJ_RECTANGLE_LABEL, 0, 0, 0);
        ObjectSetInteger(0, info_panel_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, info_panel_id, OBJPROP_XDISTANCE, InfoPanelX);
        ObjectSetInteger(0, info_panel_id, OBJPROP_YDISTANCE, InfoPanelY);
        ObjectSetInteger(0, info_panel_id, OBJPROP_XSIZE, InfoPanelWidth);
        ObjectSetInteger(0, info_panel_id, OBJPROP_YSIZE, InfoPanelHeight);
        ObjectSetInteger(0, info_panel_id, OBJPROP_BGCOLOR, InfoPanelColor);
        ObjectSetInteger(0, info_panel_id, OBJPROP_BORDER_TYPE, BORDER_FLAT);
        ObjectSetInteger(0, info_panel_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, info_panel_id, OBJPROP_STYLE, STYLE_SOLID);
        ObjectSetInteger(0, info_panel_id, OBJPROP_WIDTH, 1);
        ObjectSetInteger(0, info_panel_id, OBJPROP_BACK, false);
        ObjectSetInteger(0, info_panel_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, info_panel_id, OBJPROP_SELECTED, false);
        ObjectSetInteger(0, info_panel_id, OBJPROP_HIDDEN, true);
        ObjectSetInteger(0, info_panel_id, OBJPROP_ZORDER, 1);
    }
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≥–ª–∞
    int title_x, title_y, dt_y, user_y, risk_y, pattern_y, trend_y, zones_y;
    
    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏
    string title_id = info_panel_id + "_Title";
    if(ObjectFind(0, title_id) < 0)
    {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≥–ª–∞
        switch(InfoPanelCorner)
        {
            case CORNER_LEFT_UPPER:
            case CORNER_RIGHT_UPPER:
                title_y = 15;
                dt_y = 35;
                user_y = 55;
                risk_y = 75;
                pattern_y = 95;
                trend_y = 115;
                zones_y = 135;
                break;
            case CORNER_LEFT_LOWER:
            case CORNER_RIGHT_LOWER:
                title_y = InfoPanelHeight - 15;
                dt_y = InfoPanelHeight - 35;
                user_y = InfoPanelHeight - 55;
                risk_y = InfoPanelHeight - 75;
                pattern_y = InfoPanelHeight - 95;
                trend_y = InfoPanelHeight - 115;
                zones_y = InfoPanelHeight - 135;
                break;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≥–ª–∞
        switch(InfoPanelCorner)
        {
            case CORNER_LEFT_UPPER:
            case CORNER_LEFT_LOWER:
                title_x = InfoPanelWidth - 10;
                break;
            case CORNER_RIGHT_UPPER:
            case CORNER_RIGHT_LOWER:
                title_x = 10;
                break;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        ObjectCreate(0, title_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, title_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, title_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, title_id, OBJPROP_YDISTANCE, title_y);
        ObjectSetInteger(0, title_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, title_id, OBJPROP_FONTSIZE, 10);
        ObjectSetInteger(0, title_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, title_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, title_id, OBJPROP_TEXT, GetLocalizedText("panel_title"));
        ObjectSetString(0, title_id, OBJPROP_FONT, "Arial Bold");
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, title_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
    
    // –¢–µ–∫—Å—Ç –¥–ª—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    if(ObjectFind(0, datetime_text_id) < 0)
    {
        ObjectCreate(0, datetime_text_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_YDISTANCE, dt_y);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, datetime_text_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, datetime_text_id, OBJPROP_TEXT, GetLocalizedText("current_time") + ": " + GetCurrentDateTime());
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, datetime_text_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
    
    // –¢–µ–∫—Å—Ç –¥–ª—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if(ObjectFind(0, username_text_id) < 0)
    {
        ObjectCreate(0, username_text_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, username_text_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, username_text_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, username_text_id, OBJPROP_YDISTANCE, user_y);
        ObjectSetInteger(0, username_text_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, username_text_id, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, username_text_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, username_text_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, username_text_id, OBJPROP_TEXT, GetLocalizedText("current_user") + ": " + GetComputerUserName());
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, username_text_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
    
    // –¢–µ–∫—Å—Ç –¥–ª—è —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞
    if(ObjectFind(0, risk_text_id) < 0)
    {
        ObjectCreate(0, risk_text_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, risk_text_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, risk_text_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, risk_text_id, OBJPROP_YDISTANCE, risk_y);
        ObjectSetInteger(0, risk_text_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, risk_text_id, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, risk_text_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, risk_text_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, risk_text_id, OBJPROP_TEXT, GetLocalizedText("risk_assessment") + ": " + GetLocalizedText("risk_medium"));
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, risk_text_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
    
    // –¢–µ–∫—Å—Ç –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    if(ObjectFind(0, pattern_text_id) < 0)
    {
        ObjectCreate(0, pattern_text_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_YDISTANCE, pattern_y);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, pattern_text_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, pattern_text_id, OBJPROP_TEXT, GetLocalizedText("detected_patterns") + ": -");
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, pattern_text_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
    
    // –¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞
    if(ObjectFind(0, trend_text_id) < 0)
    {
        ObjectCreate(0, trend_text_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, trend_text_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, trend_text_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, trend_text_id, OBJPROP_YDISTANCE, trend_y);
        ObjectSetInteger(0, trend_text_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, trend_text_id, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, trend_text_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, trend_text_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, trend_text_id, OBJPROP_TEXT, GetLocalizedText("trend") + ": " + GetLocalizedText("trend_sideways"));
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, trend_text_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
    
    // –¢–µ–∫—Å—Ç –¥–ª—è —É—Ä–æ–≤–Ω–µ–π –∑–æ–Ω –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
    if(ObjectFind(0, zones_text_id) < 0)
    {
        ObjectCreate(0, zones_text_id, OBJ_LABEL, 0, 0, 0);
        ObjectSetInteger(0, zones_text_id, OBJPROP_CORNER, InfoPanelCorner);
        ObjectSetInteger(0, zones_text_id, OBJPROP_XDISTANCE, title_x);
        ObjectSetInteger(0, zones_text_id, OBJPROP_YDISTANCE, zones_y);
        ObjectSetInteger(0, zones_text_id, OBJPROP_COLOR, InfoPanelTextColor);
        ObjectSetInteger(0, zones_text_id, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, zones_text_id, OBJPROP_SELECTABLE, false);
        ObjectSetInteger(0, zones_text_id, OBJPROP_HIDDEN, true);
        ObjectSetString(0, zones_text_id, OBJPROP_TEXT, GetLocalizedText("zones") + ": -");
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if(InfoPanelCorner == CORNER_LEFT_UPPER || InfoPanelCorner == CORNER_LEFT_LOWER)
            ObjectSetInteger(0, zones_text_id, OBJPROP_ANCHOR, ANCHOR_RIGHT_UPPER);
    }
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞ –ø–∞–Ω–µ–ª–∏                                 |
//+------------------------------------------------------------------+
void UpdateInfoPanel(int bar_index, const datetime &time[])
{
    if(!ShowInfoPanel || bar_index <= 0)
        return;
        
    datetime current_time = TimeCurrent();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –Ω–µ —á–∞—â–µ, —á–µ–º —Ä–∞–∑ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    if(current_time - last_update_time < update_frequency)
        return;
        
    last_update_time = current_time;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
    double risk_value = 0;
    ENUM_RISK_LEVEL risk_level = CalculateRiskLevel(bar_index, RiskAssessmentPeriod, risk_value);
    string risk_text = "";
    
    switch(risk_level)
    {
        case RISK_LOW:
            risk_text = GetLocalizedText("risk_assessment") + ": " + GetLocalizedText("risk_low");
            ObjectSetInteger(0, risk_text_id, OBJPROP_COLOR, clrLimeGreen);
            break;
        case RISK_MEDIUM:
            risk_text = GetLocalizedText("risk_assessment") + ": " + GetLocalizedText("risk_medium");
            ObjectSetInteger(0, risk_text_id, OBJPROP_COLOR, clrYellow);
            break;
        case RISK_HIGH:
            risk_text = GetLocalizedText("risk_assessment") + ": " + GetLocalizedText("risk_high");
            ObjectSetInteger(0, risk_text_id, OBJPROP_COLOR, clrTomato);
            break;
    }
    
    ObjectSetString(0, risk_text_id, OBJPROP_TEXT, risk_text);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö
    string patterns = "";
    bool has_patterns = false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –±–∞—Ä–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    for(int i = bar_index; i >= MathMax(0, bar_index - 5); i--)
    {
        // –ü–æ–ª—É—á–∏–º —Ü–µ–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –±—É—Ñ–µ—Ä–∞
        double close[];
        int copied = CopyClose(Symbol(), PERIOD_CURRENT, i - VFI_Length, VFI_Length + 1, close);

        if(copied > 0)
        {
            if(IsDoubleBottom(i, VFI_Length))
            {
                patterns += "W ";  // Double Bottom
                has_patterns = true;
            }
            
            if(IsDoubleTop(i, VFI_Length))
            {
                patterns += "M ";  // Double Top
                has_patterns = true;
            }
            
            if(IsDivergence(i, VFI_Length, close))
            {
                patterns += "D ";  // Divergence
                has_patterns = true;
            }
        }
    }
    
    if(has_patterns)
        ObjectSetString(0, pattern_text_id, OBJPROP_TEXT, GetLocalizedText("detected_patterns") + ": " + patterns);
    else
        ObjectSetString(0, pattern_text_id, OBJPROP_TEXT, GetLocalizedText("detected_patterns") + ": " + GetLocalizedText("no_patterns_detected"));
        
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
    ObjectSetString(0, datetime_text_id, OBJPROP_TEXT, GetLocalizedText("current_time") + ": " + GetCurrentDateTime());
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    ObjectSetString(0, username_text_id, OBJPROP_TEXT, GetLocalizedText("current_user") + ": " + GetComputerUserName());
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–Ω–¥–µ
    double trend_strength = 0;
    ENUM_TREND_DIRECTION trend_direction = DetermineTrend(bar_index, TrendPeriod, trend_strength);
    string trend_text = "";
    color trend_color;
    
    switch(trend_direction)
    {
        case TREND_UP:
            trend_text = GetLocalizedText("trend") + ": " + GetLocalizedText("trend_up") + " (" + 
                         GetLocalizedText("trend_strength") + ": " + DoubleToString(trend_strength * 100, 0) + "%)";
            trend_color = clrLimeGreen;
            break;
        case TREND_DOWN:
            trend_text = GetLocalizedText("trend") + ": " + GetLocalizedText("trend_down") + " (" + 
                         GetLocalizedText("trend_strength") + ": " + DoubleToString(trend_strength * 100, 0) + "%)";
            trend_color = clrTomato;
            break;
        default:
            trend_text = GetLocalizedText("trend") + ": " + GetLocalizedText("trend_sideways");
            trend_color = clrGray;
            break;
    }
    
    ObjectSetString(0, trend_text_id, OBJPROP_TEXT, trend_text);
    ObjectSetInteger(0, trend_text_id, OBJPROP_COLOR, trend_color);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–æ–Ω–∞—Ö –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
    string zones_text = GetLocalizedText("zones") + ": " + 
                      GetLocalizedText("overbought_level") + "=" + DoubleToString(dynamic_overbought_level, 2) +
                      ", " + GetLocalizedText("oversold_level") + "=" + DoubleToString(dynamic_oversold_level, 2);
    
    ObjectSetString(0, zones_text_id, OBJPROP_TEXT, zones_text);
}

//+------------------------------------------------------------------+
//| –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏                                  |
//+------------------------------------------------------------------+
void DeleteInfoPanel()
{
    ObjectDelete(0, info_panel_id);
    ObjectDelete(0, info_panel_id + "_Title");
    ObjectDelete(0, pattern_text_id);
    ObjectDelete(0, datetime_text_id);
    ObjectDelete(0, username_text_id);
    ObjectDelete(0, risk_text_id);
    ObjectDelete(0, trend_text_id);
    ObjectDelete(0, zones_text_id);
}

//+------------------------------------------------------------------+
//| –†–∞—Å—á–µ—Ç —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞ –¥–ª—è —Å–∏–≥–Ω–∞–ª–∞                                 |
//+------------------------------------------------------------------+
ENUM_RISK_LEVEL CalculateRiskLevel(int bar_pos, int period, double &risk_value)
{
    if(bar_pos < period)
    {
        risk_value = 0.0;
        return RISK_MEDIUM;
    }
    
    // –í—ã—á–∏—Å–ª—è–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å VFI
    double vfi_sum = 0.0;
    double vfi_sum_sq = 0.0;
    double max_vfi = -DBL_MAX;
    double min_vfi = DBL_MAX;
    int valid_count = 0;
    
    for(int i = bar_pos; i > bar_pos - period && i >= 0; i--)
    {
        if(VFI_Buffer[i] != EMPTY_VALUE)
        {
            vfi_sum += VFI_Buffer[i];
            vfi_sum_sq += MathPow(VFI_Buffer[i], 2);
            if(VFI_Buffer[i] > max_vfi) max_vfi = VFI_Buffer[i];
            if(VFI_Buffer[i] < min_vfi) min_vfi = VFI_Buffer[i];
            valid_count++;
        }
    }
    
    if(valid_count < period / 2)
    {
        risk_value = 0.0;
        return RISK_MEDIUM;
    }
    
    double vfi_avg = vfi_sum / valid_count;
    double vfi_std = MathSqrt(vfi_sum_sq / valid_count - MathPow(vfi_avg, 2));
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏ —Å—Ä–µ–¥–Ω–∏–º
    double current_distance = MathAbs(VFI_Buffer[bar_pos] - vfi_avg);
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ –æ—Ç 0 –¥–æ 1
    double risk_normalized = 0.0;
    
    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (% –æ—Ç –º–∞–∫—Å-–º–∏–Ω)
    if(vfi_std > 0)
    {
        risk_normalized = current_distance / (vfi_std * 3); // 3 —Å–∏–≥–º—ã
        risk_normalized = MathMin(risk_normalized, 1.0); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ —ç–∫—Å—Ç—Ä–µ–º—É–º–∞–º
    double range_total = max_vfi - min_vfi;
    if(range_total > 0)
    {
        double extreme_factor = 0.0;
        
        if(VFI_Buffer[bar_pos] > vfi_avg) // –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
            extreme_factor = (VFI_Buffer[bar_pos] - vfi_avg) / (max_vfi - vfi_avg);
        else // –ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
            extreme_factor = (vfi_avg - VFI_Buffer[bar_pos]) / (vfi_avg - min_vfi);
            
        risk_normalized = risk_normalized * 0.7 + extreme_factor * 0.3; // 70/30 –≤–µ—Å–æ–≤–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    }
    
    risk_value = risk_normalized;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
    if(risk_normalized < 0.33)
        return RISK_LOW;
    else if(risk_normalized < 0.66)
        return RISK_MEDIUM;
    else
        return RISK_HIGH;
}

//+------------------------------------------------------------------+
//| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞                       |
//+------------------------------------------------------------------+
void UpdateDynamicColors(int bar_pos)
{
    if(!EnableDynamicColors || bar_pos <= 0)
        return;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    double vfi_current = VFI_Buffer[bar_pos];
    double vfi_prev = VFI_Buffer[bar_pos - 1];
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
    color vfi_color, ema_color;
    
    if(vfi_current > 0)
    {
        // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ VFI
        if(vfi_current > vfi_prev)
            vfi_color = clrLimeGreen;  // –†–æ—Å—Ç –Ω–∞–¥ –Ω—É–ª—ë–º - —è—Ä–∫–æ-–∑–µ–ª—ë–Ω—ã–π
        else
            vfi_color = clrGreen;      // –ü–∞–¥–µ–Ω–∏–µ –Ω–∞–¥ –Ω—É–ª—ë–º - –æ–±—ã—á–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π
    }
    else
    {
        // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ VFI
        if(vfi_current < vfi_prev)
            vfi_color = clrCrimson;    // –ü–∞–¥–µ–Ω–∏–µ –ø–æ–¥ –Ω—É–ª—ë–º - —è—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π
        else
            vfi_color = clrRed;        // –†–æ—Å—Ç –ø–æ–¥ –Ω—É–ª—ë–º - –æ–±—ã—á–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π
    }
    
    // –¶–≤–µ—Ç EMA –ª–∏–Ω–∏–∏ –º–µ–Ω—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å VFI
    if(vfi_current > VFI_EMA_Buffer[bar_pos])
        ema_color = clrOrange;         // VFI –≤—ã—à–µ EMA - –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    else
        ema_color = clrDarkOrange;     // VFI –Ω–∏–∂–µ EMA - —Ç–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    PlotIndexSetInteger(0, PLOT_LINE_COLOR, vfi_color);
    PlotIndexSetInteger(1, PLOT_LINE_COLOR, ema_color);
}

//+------------------------------------------------------------------+
//| Custom indicator initialization function                         |
//+------------------------------------------------------------------+
int OnInit()
{
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Ä–µ–º–µ–Ω–∏
    session_start_time = TimeGMT();
    indicator_load_time = TimeCurrent();  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    Print("Indicator loaded at: ", TimeToString(indicator_load_time));
    
    // Validate input parameters
    if(VFI_Length < 10)
    {
        Print("‚ùå ", GetLocalizedText("parameter_error"), ": ", GetLocalizedText("invalid_vfi_length"));
        return(INIT_PARAMETERS_INCORRECT);
    }
    
    if(SignalLength < 1)
    {
        Print("‚ùå ", GetLocalizedText("parameter_error"), ": ", GetLocalizedText("invalid_signal_length"));
        return(INIT_PARAMETERS_INCORRECT);
    }
    
    if(Coef <= 0 || VCoef <= 0)
    {
        Print("‚ùå ", GetLocalizedText("parameter_error"), ": ", GetLocalizedText("invalid_coefficients"));
        return(INIT_PARAMETERS_INCORRECT);
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–æ–Ω
    if(ZonesAutoCalculationPeriod < 20)
    {
        Print("‚ùå ", GetLocalizedText("parameter_error"), ": ", "ZonesAutoCalculationPeriod must be >= 20");
        return(INIT_PARAMETERS_INCORRECT);
    }
    
    if(ZonePercentile <= 0 || ZonePercentile >= 100)
    {
        Print("‚ùå ", GetLocalizedText("parameter_error"), ": ", "ZonePercentile must be between 0 and 100");
        return(INIT_PARAMETERS_INCORRECT);
    }
    
    // Determine system language
    is_russian_system = IsRussianSystem();
    
    // –í–ê–ñ–ù–û: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    last_calculated = 0;
    
    //--- indicator buffers mapping
    SetIndexBuffer(0, VFI_Buffer, INDICATOR_DATA);
    SetIndexBuffer(1, VFI_EMA_Buffer, INDICATOR_DATA);
    SetIndexBuffer(2, Histogram_Buffer, INDICATOR_DATA);
    SetIndexBuffer(3, Buy_Signal_Buffer, INDICATOR_DATA);
    SetIndexBuffer(4, Sell_Signal_Buffer, INDICATOR_DATA);
    SetIndexBuffer(5, DoubleBottom_Buffer, INDICATOR_CALCULATIONS);  // –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
    SetIndexBuffer(6, DoubleTop_Buffer, INDICATOR_CALCULATIONS);     // –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
    SetIndexBuffer(7, Divergence_Buffer, INDICATOR_CALCULATIONS);    // –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
    SetIndexBuffer(8, Risk_Buffer, INDICATOR_DATA);
    SetIndexBuffer(9, Risk_Colors_Buffer, INDICATOR_COLOR_INDEX);
    SetIndexBuffer(10, VCP_Buffer, INDICATOR_CALCULATIONS);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—É—Ñ–µ—Ä–∞ –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
    ArrayResize(trend_buffer, 0);
    
    //--- set arrow codes for the signals
    PlotIndexSetInteger(3, PLOT_ARROW, 233); // Up arrow for buy
    PlotIndexSetInteger(4, PLOT_ARROW, 234); // Down arrow for sell
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    PlotIndexSetInteger(5, PLOT_DRAW_TYPE, DRAW_NONE);  // Double Bottom
    PlotIndexSetInteger(6, PLOT_DRAW_TYPE, DRAW_NONE);  // Double Top
    PlotIndexSetInteger(7, PLOT_DRAW_TYPE, DRAW_NONE);  // Divergence
    
    //--- set accuracy
    IndicatorSetInteger(INDICATOR_DIGITS, 4);
    
    //--- set short name
    IndicatorSetString(INDICATOR_SHORTNAME, "VFI_DubravaSPB(" + 
                      IntegerToString(VFI_Length) + "," + 
                      DoubleToString(Coef, 1) + "," + 
                      DoubleToString(VCoef, 1) + ")");
    
    //--- set zero level
    IndicatorSetDouble(INDICATOR_LEVELVALUE, 0, 0.0);
    
    //--- set empty values
    PlotIndexSetDouble(0, PLOT_EMPTY_VALUE, EMPTY_VALUE);
    PlotIndexSetDouble(1, PLOT_EMPTY_VALUE, EMPTY_VALUE);
    PlotIndexSetDouble(2, PLOT_EMPTY_VALUE, EMPTY_VALUE);
    PlotIndexSetDouble(3, PLOT_EMPTY_VALUE, EMPTY_VALUE);
    PlotIndexSetDouble(4, PLOT_EMPTY_VALUE, EMPTY_VALUE);
    PlotIndexSetDouble(8, PLOT_EMPTY_VALUE, EMPTY_VALUE);
    
    //--- hide histogram if not needed
    if(!ShowHisto)
        PlotIndexSetInteger(2, PLOT_DRAW_TYPE, DRAW_NONE);
    else
        PlotIndexSetInteger(2, PLOT_DRAW_TYPE, DRAW_HISTOGRAM);
    
    //--- initialize calculation arrays
    ArrayResize(inter_array, 0);
    ArrayResize(typical_array, 0);
    ArrayResize(volatility_array, 0);
    ArrayResize(price_array, 0);
    
    // –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
    if(ShowInfoPanel)
    {
        CreateInfoPanel();
        Print(" ", GetLocalizedText("info_panel_enabled"));
    }
    
    // Log that signals are enabled
    Print(" ", GetLocalizedText("buy_signals_enabled"));
    Print(" ", GetLocalizedText("sell_signals_enabled"));
    
    // Log additional features
    if(ShowPatterns)
        Print(" ", GetLocalizedText("pattern_recognition_enabled"));
    
    if(EnableAlerts)
        Print(" ", GetLocalizedText("alerts_enabled"));
        
    if(EnableNotifications)
        Print(" ", GetLocalizedText("notifications_enabled"));
        
    if(EnableDynamicColors)
        Print(" ", GetLocalizedText("dynamic_colors_enabled"));
    
    // –õ–æ–≥–∏—Ä—É–µ–º –≤–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–æ–Ω
    Print(" ", GetLocalizedText("auto_zones"));
    
    //--- check volume data
    CheckVolumeData();
    
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±—ä–µ–º–∞–º                   |
//+------------------------------------------------------------------+
void CheckVolumeData()
{
    string symbol = Symbol();
    string username = GetComputerUserName();
    string datetime_str = GetCurrentDateTime();
    
    Print(GetLocalizedText("volume_check_header"));
    Print(" ", GetLocalizedText("symbol"), ": ", symbol);
    Print(" ", GetLocalizedText("datetime"), ": ", datetime_str, " UTC");
    Print(" ", GetLocalizedText("user"), ": ", username);
    
    // Debug terminal paths
    Print(" ", GetLocalizedText("terminal_paths"), ":");
    Print("   TERMINAL_PATH: ", TerminalInfoString(TERMINAL_PATH));
    Print("   TERMINAL_DATA_PATH: ", TerminalInfoString(TERMINAL_DATA_PATH));
    Print("   TERMINAL_COMMONDATA_PATH: ", TerminalInfoString(TERMINAL_COMMONDATA_PATH));
    
    // Check execution type
    ENUM_SYMBOL_TRADE_EXECUTION execution = (ENUM_SYMBOL_TRADE_EXECUTION)SymbolInfoInteger(symbol, SYMBOL_TRADE_EXEMODE);
    string exec_type = "";
    switch(execution)
    {
        case SYMBOL_TRADE_EXECUTION_REQUEST: exec_type = "Request"; break;
        case SYMBOL_TRADE_EXECUTION_INSTANT: exec_type = "Instant"; break;
        case SYMBOL_TRADE_EXECUTION_MARKET: exec_type = "Market"; break;
        case SYMBOL_TRADE_EXECUTION_EXCHANGE: exec_type = "Exchange"; break;
        default: exec_type = "Unknown";
    }
    Print(" ", GetLocalizedText("execution_type"), ": ", exec_type);
    
    // Get test data
    MqlRates rates[];
    int copied = CopyRates(symbol, PERIOD_CURRENT, 0, 100, rates);
    
    if(copied <= 0)
    {
        Print(" ", GetLocalizedText("error_no_data"));
        return;
    }
    
    Print(" ", GetLocalizedText("bars_analyzed"), ": ", copied);
    
    // Analyze tick volumes
    long total_tick_volume = 0;
    long max_tick_volume = 0;
    long min_tick_volume = LONG_MAX;
    int zero_tick_volumes = 0;
    
    // Analyze real volumes
    long total_real_volume = 0;
    long max_real_volume = 0;
    long min_real_volume = LONG_MAX;
    int zero_real_volumes = 0;
    bool has_real_volumes = false;
    
    for(int i = 0; i < copied; i++)
    {
        // Tick volumes
        if(rates[i].tick_volume == 0)
            zero_tick_volumes++;
        
        total_tick_volume += rates[i].tick_volume;
        
        if(rates[i].tick_volume > max_tick_volume)
            max_tick_volume = rates[i].tick_volume;
            
        if(rates[i].tick_volume < min_tick_volume && rates[i].tick_volume > 0)
            min_tick_volume = rates[i].tick_volume;
        
        // Real volumes
        if(rates[i].real_volume > 0)
        {
            has_real_volumes = true;
            total_real_volume += rates[i].real_volume;
            
            if(rates[i].real_volume > max_real_volume)
                max_real_volume = rates[i].real_volume;
                
            if(rates[i].real_volume < min_real_volume)
                min_real_volume = rates[i].real_volume;
        }
        else
        {
            zero_real_volumes++;
        }
    }
    
    // Tick volume results
    double avg_tick_volume = (double)total_tick_volume / copied;
    Print(" ", GetLocalizedText("tick_volumes"), ":");
    Print("   ", GetLocalizedText("average"), ": ", (long)avg_tick_volume);
    Print("   ", GetLocalizedText("maximum"), ": ", max_tick_volume);
    Print("   ", GetLocalizedText("minimum"), ": ", min_tick_volume);
    Print("   ", GetLocalizedText("zero_bars"), ": ", zero_tick_volumes, " (", 
          MathRound(zero_tick_volumes * 100.0 / copied), "%)");
    
    // Real volume results
    real_volumes_available = has_real_volumes;
    if(has_real_volumes)
    {
        double avg_real_volume = (double)total_real_volume / (copied - zero_real_volumes);
        Print(" ", GetLocalizedText("real_volumes"), ":");
        Print("   ", GetLocalizedText("average"), ": ", (long)avg_real_volume);
        Print("   ", GetLocalizedText("maximum"), ": ", max_real_volume);
        Print("   ", GetLocalizedText("minimum"), ": ", min_real_volume);
        Print("   ", GetLocalizedText("zero_bars"), ": ", zero_real_volumes, " (", 
              MathRound(zero_real_volumes * 100.0 / copied), "%)");
    }
    else
    {
        Print(" ", GetLocalizedText("real_volumes_unavailable"));
    }
    
    // Data quality assessment
    string quality_assessment = "";
    string recommendation = "";
    
    if(!has_real_volumes && zero_tick_volumes > copied * 0.5)
    {
        quality_assessment = GetLocalizedText("critical_no_volumes");
        recommendation = GetLocalizedText("change_instrument");
    }
    else if(!has_real_volumes && (max_tick_volume - min_tick_volume) < avg_tick_volume * 0.1)
    {
        quality_assessment = GetLocalizedText("poor_no_variation");
        recommendation = GetLocalizedText("may_work_incorrectly");
    }
    else if(!has_real_volumes)
    {
        quality_assessment = GetLocalizedText("satisfactory_tick_only");
        recommendation = GetLocalizedText("will_work_less_accurate");
    }
    else if(has_real_volumes && zero_real_volumes < copied * 0.1)
    {
        quality_assessment = GetLocalizedText("excellent_real_volumes");
        recommendation = GetLocalizedText("will_work_max_accurate");
    }
    else
    {
        quality_assessment = GetLocalizedText("good_real_gaps");
        recommendation = GetLocalizedText("will_work_correctly");
    }
    
    Print(" ", GetLocalizedText("quality_assessment"), ": ", quality_assessment);
    Print(" ", GetLocalizedText("recommendation"), ": ", recommendation);
    
    // Indicator settings
    Print(" ", GetLocalizedText("indicator_settings"), ":");
    
    if(has_real_volumes && UseRealVolume)
    {
        Print("   ", GetLocalizedText("will_use_real"));
    }
    else
    {
        Print("   ", GetLocalizedText("will_use_tick"));
    }
    
    Print("   VFI Length: ", VFI_Length);
    Print("   Coefficient: ", Coef);
    Print("   Max Volume Cutoff: ", VCoef);
    Print("   Signal Length: ", SignalLength);
    Print("   Trend Period: ", TrendPeriod);
    Print("   Zones Auto Calculation Period: ", ZonesAutoCalculationPeriod);
    Print("   Zone Percentile: ", ZonePercentile);
    Print("   Zone Transparency: ", ZoneTransparency);
    Print("   Smooth VFI: ", SmoothVFI ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Show Histogram: ", ShowHisto ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Show Patterns: ", ShowPatterns ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Enable Alerts: ", EnableAlerts ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Enable Notifications: ", EnableNotifications ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Enable Dynamic Colors: ", EnableDynamicColors ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Show Info Panel: ", ShowInfoPanel ? GetLocalizedText("yes") : GetLocalizedText("no"));
    Print("   Risk Assessment Period: ", RiskAssessmentPeriod);
}

//+------------------------------------------------------------------+
//| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –¥–Ω–∞ –≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ                          |
//+------------------------------------------------------------------+
bool IsDoubleBottom(int bar_pos, int range)
{
    if(bar_pos < range * 2)
        return false;
        
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤–ø–∞–¥–∏–Ω–∞–º–∏
    int min_distance = range / 3;
    if(min_distance < 3) min_distance = 3;
    
    // –ò—â–µ–º –¥–≤–µ –≤–ø–∞–¥–∏–Ω—ã
    double min_value1 = VFI_Buffer[bar_pos];
    int min_pos1 = bar_pos;
    
    // –ò—â–µ–º –ø–µ—Ä–≤—É—é –≤–ø–∞–¥–∏–Ω—É
    for(int i = bar_pos - range; i <= bar_pos; i++)
    {
        if(i >= 0 && VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i] < min_value1)
        {
            min_value1 = VFI_Buffer[i];
            min_pos1 = i;
        }
    }
    
    // –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è –≤–ø–∞–¥–∏–Ω–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –±–∞—Ä–æ–º, –∑–Ω–∞—á–∏—Ç –æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
    if(min_pos1 == bar_pos)
        return false;
        
    // –ò—â–µ–º –≤—Ç–æ—Ä—É—é –≤–ø–∞–¥–∏–Ω—É –¥–æ –ø–µ—Ä–≤–æ–π –≤–ø–∞–¥–∏–Ω—ã
    double min_value2 = VFI_Buffer[0];
    int min_pos2 = -1;
    
    for(int i = min_pos1 - min_distance; i >= min_pos1 - range && i >= 0; i--)
    {
        if(VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i] <= min_value1 * 1.05 && 
           VFI_Buffer[i] >= min_value1 * 0.95) // –ü–æ—Ö–æ–∂–∏–π —É—Ä–æ–≤–µ–Ω—å (¬±5%)
        {
            min_value2 = VFI_Buffer[i];
            min_pos2 = i;
            break;
        }
    }
    
    // –ï—Å–ª–∏ –≤—Ç–æ—Ä–∞—è –≤–ø–∞–¥–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
    if(min_pos2 < 0)
        return false;
        
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∏–∫ –º–µ–∂–¥—É –≤–ø–∞–¥–∏–Ω–∞–º–∏
    double max_between = min_value1;
    for(int i = min_pos2; i <= min_pos1; i++)
    {
        if(VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i] > max_between)
        {
            max_between = VFI_Buffer[i];
        }
    }
    
    // –ü–∏–∫ –º–µ–∂–¥—É –≤–ø–∞–¥–∏–Ω–∞–º–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ –º–∏–Ω–∏–º—É–º–∞ —Ö–æ—Ç—è –±—ã –Ω–∞ 20%
    return (max_between > min_value1 * 1.2);
}

//+------------------------------------------------------------------+
//| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π –≤–µ—Ä—à–∏–Ω—ã –≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ                       |
//+------------------------------------------------------------------+
bool IsDoubleTop(int bar_pos, int range)
{
    if(bar_pos < range * 2)
        return false;
        
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–∏–∫–∞–º–∏
    int min_distance = range / 3;
    if(min_distance < 3) min_distance = 3;
    
    // –ò—â–µ–º –¥–≤–∞ –ø–∏–∫–∞
    double max_value1 = VFI_Buffer[bar_pos];
    int max_pos1 = bar_pos;
    
    // –ò—â–µ–º –ø–µ—Ä–≤—ã–π –ø–∏–∫
    for(int i = bar_pos - range; i <= bar_pos; i++)
    {
        if(i >= 0 && VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i] > max_value1)
        {
            max_value1 = VFI_Buffer[i];
            max_pos1 = i;
        }
    }
    
    // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø–∏–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –±–∞—Ä–æ–º, –∑–Ω–∞—á–∏—Ç –æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
    if(max_pos1 == bar_pos)
        return false;
        
    // –ò—â–µ–º –≤—Ç–æ—Ä–æ–π –ø–∏–∫ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–∏–∫–∞
    double max_value2 = VFI_Buffer[0];
    int max_pos2 = -1;
    
    for(int i = max_pos1 - min_distance; i >= max_pos1 - range && i >= 0; i--)
    {
        if(VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i] >= max_value1 * 0.95 && 
           VFI_Buffer[i] <= max_value1 * 1.05) // –ü–æ—Ö–æ–∂–∏–π —É—Ä–æ–≤–µ–Ω—å (¬±5%)
        {
            max_value2 = VFI_Buffer[i];
            max_pos2 = i;
            break;
        }
    }
    
    // –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π –ø–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω
    if(max_pos2 < 0)
        return false;
        
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–ø–∞–¥–∏–Ω–∞ –º–µ–∂–¥—É –ø–∏–∫–∞–º–∏
    double min_between = max_value1;
    for(int i = max_pos2; i <= max_pos1; i++)
    {
        if(VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i] < min_between)
        {
            min_between = VFI_Buffer[i];
        }
    }
    
    // –í–ø–∞–¥–∏–Ω–∞ –º–µ–∂–¥—É –ø–∏–∫–∞–º–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∏–∂–µ –º–∞–∫—Å–∏–º—É–º–∞ —Ö–æ—Ç—è –±—ã –Ω–∞ 20%
    return (min_between < max_value1 * 0.8);
}

//+------------------------------------------------------------------+
//| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –º–µ–∂–¥—É —Ü–µ–Ω–æ–π –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º               |
//+------------------------------------------------------------------+
bool IsDivergence(int bar_pos, int range, const double &close[])
{
    if(bar_pos < range * 2)
        return false;
        
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
    int min_distance = range / 3;
    if(min_distance < 3) min_distance = 3;
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º—É–º—ã/–º–∏–Ω–∏–º—É–º—ã –≤ —Ü–µ–Ω–µ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ
    double price_high1 = close[0];
    double price_low1 = close[0];
    double vfi_high1 = VFI_Buffer[bar_pos];
    double vfi_low1 = VFI_Buffer[bar_pos];
    int price_high_pos1 = bar_pos;
    int price_low_pos1 = bar_pos;
    int vfi_high_pos1 = bar_pos;
    int vfi_low_pos1 = bar_pos;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã
    int start_pos = MathMin(bar_pos, ArraySize(close) - 1);
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ —ç–∫—Å—Ç—Ä–µ–º—É–º—ã
    for(int i = 0; i < range / 2 && i < start_pos; i++)
    {
        int idx = start_pos - i;
        // –ú–∞–∫—Å–∏–º—É–º—ã –∏ –º–∏–Ω–∏–º—É–º—ã —Ü–µ–Ω—ã
        if(idx >= 0 && idx < ArraySize(close))
        {
            if(close[idx] > price_high1)
            {
                price_high1 = close[idx];
                price_high_pos1 = idx;
            }
            if(close[idx] < price_low1)
            {
                price_low1 = close[idx];
                price_low_pos1 = idx;
            }
        }
        
        // –ú–∞–∫—Å–∏–º—É–º—ã –∏ –º–∏–Ω–∏–º—É–º—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        if(idx >= 0 && idx < ArraySize(VFI_Buffer) && VFI_Buffer[idx] != EMPTY_VALUE)
        {
            if(VFI_Buffer[idx] > vfi_high1)
            {
                vfi_high1 = VFI_Buffer[idx];
                vfi_high_pos1 = idx;
            }
            if(VFI_Buffer[idx] < vfi_low1)
            {
                vfi_low1 = VFI_Buffer[idx];
                vfi_low_pos1 = idx;
            }
        }
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Ç–æ—Ä—ã–µ —ç–∫—Å—Ç—Ä–µ–º—É–º—ã
    double price_high2 = price_high1;
    double price_low2 = price_low1;
    double vfi_high2 = vfi_high1;
    double vfi_low2 = vfi_low1;
    int price_high_pos2 = -1;
    int price_low_pos2 = -1;
    int vfi_high_pos2 = -1;
    int vfi_low_pos2 = -1;
    
    int second_start = MathMax(0, start_pos - range / 2 - 1);
    int second_end = MathMax(0, start_pos - range);
    
    for(int i = second_start; i >= second_end; i--)
    {
        // –ú–∞–∫—Å–∏–º—É–º—ã –∏ –º–∏–Ω–∏–º—É–º—ã —Ü–µ–Ω—ã
        if(i < ArraySize(close))
        {
            if(close[i] > price_high2)
            {
                price_high2 = close[i];
                price_high_pos2 = i;
            }
            if(close[i] < price_low2)
            {
                price_low2 = close[i];
                price_low_pos2 = i;
            }
        }
        
        // –ú–∞–∫—Å–∏–º—É–º—ã –∏ –º–∏–Ω–∏–º—É–º—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        if(i < ArraySize(VFI_Buffer) && VFI_Buffer[i] != EMPTY_VALUE)
        {
            if(VFI_Buffer[i] > vfi_high2)
            {
                vfi_high2 = VFI_Buffer[i];
                vfi_high_pos2 = i;
            }
            if(VFI_Buffer[i] < vfi_low2)
            {
                vfi_low2 = VFI_Buffer[i];
                vfi_low_pos2 = i;
            }
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã—á—å—é –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—é: —Ü–µ–Ω—ã –¥–µ–ª–∞—é—Ç –±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–µ –º–∏–Ω–∏–º—É–º—ã, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ
    if(price_low_pos2 >= 0 && vfi_low_pos2 >= 0 &&
       price_low2 < price_low1 && vfi_low2 > vfi_low1)
    {
        return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–¥–≤–µ–∂—å—é –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—é: —Ü–µ–Ω—ã –¥–µ–ª–∞—é—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ –º–∞–∫—Å–∏–º—É–º—ã, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - –±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–µ
    if(price_high_pos2 >= 0 && vfi_high_pos2 >= 0 &&
       price_high2 > price_high1 && vfi_high2 < vfi_high1)
    {
        return true;
    }
    
    return false;
}

//+------------------------------------------------------------------+
//| Custom indicator iteration function                              |
//+------------------------------------------------------------------+
int OnCalculate(const int rates_total,
                const int prev_calculated,
                const datetime &time[],
                const double &open[],
                const double &high[],
                const double &low[],
                const double &close[],
                const long &tick_volume[],
                const long &volume[],
                const int &spread[])
{
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ä–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    int min_bars = VFI_Length + 50;
    if(rates_total < min_bars)
        return(0);
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ
    bool recalculate_all = false;
    if(prev_calculated == 0 || last_calculated > prev_calculated)
    {
        recalculate_all = true;
        last_calculated = 0;
        
        Print("‚ÑπÔ∏è ", GetLocalizedText("settings_changed"));
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±—É—Ñ–µ—Ä—ã
        ArrayInitialize(VFI_Buffer, EMPTY_VALUE);
        ArrayInitialize(VFI_EMA_Buffer, EMPTY_VALUE);
        ArrayInitialize(Histogram_Buffer, EMPTY_VALUE);
        ArrayInitialize(Buy_Signal_Buffer, EMPTY_VALUE);
        ArrayInitialize(Sell_Signal_Buffer, EMPTY_VALUE);
        ArrayInitialize(DoubleBottom_Buffer, EMPTY_VALUE);
        ArrayInitialize(DoubleTop_Buffer, EMPTY_VALUE);
        ArrayInitialize(Divergence_Buffer, EMPTY_VALUE);
        ArrayInitialize(Risk_Buffer, EMPTY_VALUE);
        ArrayInitialize(Risk_Colors_Buffer, 0);
        ArrayInitialize(VCP_Buffer, 0.0);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–æ–Ω
        dynamic_overbought_level = 0;
        dynamic_oversold_level = 0;
        
        // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –∑–æ–Ω
        ObjectDelete(0, overbought_zone_id);
        ObjectDelete(0, oversold_zone_id);
        ObjectDelete(0, overbought_line_id);
        ObjectDelete(0, oversold_line_id);
    }
    
    // –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ —Ç—Ä–µ–Ω–¥–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if(ArraySize(trend_buffer) != rates_total || recalculate_all)
        ArrayResize(trend_buffer, rates_total);
    
    //--- resize calculation arrays
    if(ArraySize(inter_array) != rates_total || recalculate_all)
    {
        ArrayResize(inter_array, rates_total);
        ArrayResize(typical_array, rates_total);
        ArrayResize(volatility_array, rates_total);
        ArrayResize(price_array, rates_total);
        ArrayInitialize(inter_array, 0.0);
        ArrayInitialize(typical_array, 0.0);
        ArrayInitialize(volatility_array, 0.0);
        ArrayInitialize(price_array, 0.0);
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    int start;
    if(recalculate_all)
    {
        start = min_bars;
    }
    else
    {
        start = MathMax(prev_calculated - 1, min_bars);
    }
    
    //--- calculate typical prices and inter values from the beginning
    int calc_start = recalculate_all ? 1 : MathMax(1, start - 100);
    
    for(int i = calc_start; i < rates_total; i++)
    {
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ü–µ–Ω
        if(high[i] <= 0 || low[i] <= 0 || close[i] <= 0)
        {
            typical_array[i] = i > 0 ? typical_array[i-1] : close[i];
            price_array[i] = close[i];
        }
        else
        {
            typical_array[i] = (high[i] + low[i] + close[i]) / 3.0;
            price_array[i] = close[i];
        }
        
        if(i > 0 && typical_array[i-1] > 0 && typical_array[i] > 0)
        {
            double log_diff = MathLog(typical_array[i]) - MathLog(typical_array[i-1]);
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if(MathAbs(log_diff) > 1.0) // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 100% –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                log_diff = log_diff > 0 ? 1.0 : -1.0;
            inter_array[i] = log_diff;
        }
        else
        {
            inter_array[i] = 0.0;
        }
    }
    
    // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Å—á–µ—Ç VFI –Ω–∞—á–∏–Ω–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –≤—Å–µ—Ö –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    for(int i = start; i < rates_total; i++)
    {
        //--- calculate vinter (standard deviation of inter over 30 periods)
        double vinter = CalculateStdDev(i, MathMin(30, i));
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        if(vinter < 0.0001)
            vinter = 0.0001;
        
        //--- calculate cutoff
        double cutoff = Coef * vinter * close[i];
        
        //--- calculate volume average over VFI_Length periods
        double vave = 0.0;
        int vol_start = MathMax(0, i - VFI_Length);
        int vol_count = 0;
        
        // Determine which volumes to use
        bool use_real = UseRealVolume && real_volumes_available;
        
        for(int j = vol_start; j < i; j++)
        {
            double vol_value = use_real ? (double)volume[j] : (double)tick_volume[j];
            if(vol_value > 0) // –ò—Å–∫–ª—é—á–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –æ–±—ä–µ–º—ã
            {
                vave += vol_value;
                vol_count++;
            }
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
        if(vol_count > 0)
            vave /= (double)vol_count;
        else
            vave = use_real ? (double)volume[i] : (double)tick_volume[i];
            
        if(vave <= 0)
            vave = 1.0; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        
        //--- calculate vmax
        double vmax = vave * VCoef;
        
        //--- calculate vc (min of current volume and vmax)
        double vol_current = use_real ? (double)volume[i] : (double)tick_volume[i];
        if(vol_current <= 0)
            vol_current = vave; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            
        double vc = MathMin(vol_current, vmax);
        
        //--- calculate mf (money flow)
        double mf = 0.0;
        if(i > 0)
            mf = typical_array[i] - typical_array[i-1];
        
        //--- calculate vcp
        double vcp = 0.0;
        if(mf > cutoff)
            vcp = vc;
        else if(mf < -cutoff)
            vcp = -vc;
        else
            vcp = 0.0;
        
        VCP_Buffer[i] = vcp;
        
        //--- calculate VFI (sum of vcp over VFI_Length periods divided by vave)
        double vcp_sum = 0.0;
        int vcp_start = MathMax(0, i - VFI_Length + 1);
        for(int j = vcp_start; j <= i; j++)
        {
            vcp_sum += VCP_Buffer[j];
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        double vfi_raw = vcp_sum / vave;
        if(MathAbs(vfi_raw) > 1000) // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            vfi_raw = vfi_raw > 0 ? 1000 : -1000;
        
        //--- apply smoothing if needed (SMA with period 3)
        if(SmoothVFI && i >= start + 2)
        {
            double vfi_sum = vfi_raw;
            int count = 1;
            
            for(int j = 1; j <= 2 && (i-j) >= start; j++)
            {
                if(VFI_Buffer[i-j] != EMPTY_VALUE)
                {
                    vfi_sum += VFI_Buffer[i-j];
                    count++;
                }
            }
            
            VFI_Buffer[i] = vfi_sum / count;
        }
        else
        {
            VFI_Buffer[i] = vfi_raw;
        }
        
        //--- calculate VFI EMA
        if(i == start || VFI_EMA_Buffer[i-1] == EMPTY_VALUE)
        {
            VFI_EMA_Buffer[i] = VFI_Buffer[i];
        }
        else
        {
            double alpha = 2.0 / (SignalLength + 1.0);
            VFI_EMA_Buffer[i] = alpha * VFI_Buffer[i] + (1.0 - alpha) * VFI_EMA_Buffer[i-1];
        }
        
        //--- calculate histogram
        if(ShowHisto)
            Histogram_Buffer[i] = VFI_Buffer[i] - VFI_EMA_Buffer[i];
        else
            Histogram_Buffer[i] = EMPTY_VALUE;
            
        //--- Calculate buy and sell signals
        Buy_Signal_Buffer[i] = EMPTY_VALUE;
        Sell_Signal_Buffer[i] = EMPTY_VALUE;
        
        if(i > 0 && VFI_Buffer[i] != EMPTY_VALUE && VFI_Buffer[i-1] != EMPTY_VALUE && 
           VFI_EMA_Buffer[i] != EMPTY_VALUE && VFI_EMA_Buffer[i-1] != EMPTY_VALUE)
        {
            // Buy signal: VFI crosses above EMA
            bool buy_signal = (VFI_Buffer[i-1] < VFI_EMA_Buffer[i-1] && VFI_Buffer[i] > VFI_EMA_Buffer[i]);
            
            if(buy_signal)
            {
                Buy_Signal_Buffer[i] = VFI_Buffer[i] - 0.0005; // Place slightly below the VFI line
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –Ω–∞ —Å–∏–≥–Ω–∞–ª –ø–æ–∫—É–ø–∫–∏
                if(EnableAlerts || EnableNotifications)
                {
                    string alert_message = Symbol() + ": " + GetLocalizedText("buy_signal_detected") + " @ " +
                                        TimeToString(time[i], TIME_DATE|TIME_MINUTES);
                    SendAlert(alert_message, time[i]);
                }
            }
            
            // Sell signal: VFI crosses below EMA
            bool sell_signal = (VFI_Buffer[i-1] > VFI_EMA_Buffer[i-1] && VFI_Buffer[i] < VFI_EMA_Buffer[i]);
            
            if(sell_signal)
            {
                Sell_Signal_Buffer[i] = VFI_Buffer[i] + 0.0005; // Place slightly above the VFI line
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –Ω–∞ —Å–∏–≥–Ω–∞–ª –ø—Ä–æ–¥–∞–∂–∏
                if(EnableAlerts || EnableNotifications)
                {
                    string alert_message = Symbol() + ": " + GetLocalizedText("sell_signal_detected") + " @ " +
                                        TimeToString(time[i], TIME_DATE|TIME_MINUTES);
                    SendAlert(alert_message, time[i]);
                }
            }
        }
        
        //--- Pattern Detection (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        if(ShowPatterns && i > VFI_Length * 2)
        {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –¥–Ω–∞
            if(IsDoubleBottom(i, VFI_Length))
            {
                DoubleBottom_Buffer[i] = VFI_Buffer[i]; // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–≤–æ–π–Ω–æ–≥–æ –¥–Ω–∞
                if(EnableAlerts || EnableNotifications)
                {
                    string alert_message = Symbol() + ": " + GetLocalizedText("double_bottom_detected") + " @ " +
                                        TimeToString(time[i], TIME_DATE|TIME_MINUTES);
                    SendAlert(alert_message, time[i]);
                }
            }
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π –≤–µ—Ä—à–∏–Ω—ã
            if(IsDoubleTop(i, VFI_Length))
            {
                DoubleTop_Buffer[i] = VFI_Buffer[i]; // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–≤–æ–π–Ω–æ–π –≤–µ—Ä—à–∏–Ω—ã
                if(EnableAlerts || EnableNotifications)
                {
                    string alert_message = Symbol() + ": " + GetLocalizedText("double_top_detected") + " @ " +
                                        TimeToString(time[i], TIME_DATE|TIME_MINUTES);
                    SendAlert(alert_message, time[i]);
                }
            }
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ close[], –∞ –Ω–µ ChartClose()
            double close_data[];
            int copied = CopyClose(Symbol(), PERIOD_CURRENT, i - VFI_Length, VFI_Length + 1, close_data);
            
            if(copied > 0)
            {
                if(IsDivergence(i, VFI_Length, close_data))
                {
                    Divergence_Buffer[i] = VFI_Buffer[i]; // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
                    if(EnableAlerts || EnableNotifications)
                    {
                        string alert_message = Symbol() + ": " + GetLocalizedText("divergence_detected") + " @ " +
                                            TimeToString(time[i], TIME_DATE|TIME_MINUTES);
                        SendAlert(alert_message, time[i]);
                    }
                }
            }
        }
        
        //--- Risk Assessment
        double risk_value = 0.0;
        ENUM_RISK_LEVEL risk_level = CalculateRiskLevel(i, RiskAssessmentPeriod, risk_value);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ü–≤–µ—Ç —Ä–∏—Å–∫–∞
        Risk_Buffer[i] = risk_value * 0.5; // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        Risk_Colors_Buffer[i] = (double)risk_level;
        
        //--- Trend Assessment
        double trend_strength = 0;
        ENUM_TREND_DIRECTION trend_direction = DetermineTrend(i, TrendPeriod, trend_strength);
        trend_buffer[i] = (double)trend_direction * trend_strength; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –±—É—Ñ–µ—Ä —Ç—Ä–µ–Ω–¥–∞
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤
        if(EnableDynamicColors)
            UpdateDynamicColors(i);
    }
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–Ω–∏ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
    // –ù–∞ –ø–µ—Ä–≤–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –µ—Å–ª–∏ —É—Ä–æ–≤–Ω–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
    if(prev_calculated == 0 || dynamic_overbought_level == 0 || dynamic_oversold_level == 0)
    {
        CalculateOverboughtOversoldLevels(rates_total - 1);
    }
    else if((rates_total - 1) % 100 == 0) // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 100 –±–∞—Ä–æ–≤
    {
        CalculateOverboughtOversoldLevels(rates_total - 1);
    }
    
    // –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—ã
    UpdateZoneObjects(rates_total-1);
    
    // –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
    if(ShowInfoPanel)
    {
        UpdateInfoPanel(rates_total-1, time);
    }
    
    last_calculated = rates_total;
    return(rates_total);
}

//+------------------------------------------------------------------+
//| Calculate Standard Deviation for inter values - IMPROVED        |
//+------------------------------------------------------------------+
double CalculateStdDev(int pos, int period)
{
    if(pos < 1 || period < 1)
        return(0.0001); // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ 0
    
    int actual_period = MathMin(period, pos + 1);
    int start_pos = pos - actual_period + 1;
    
    //--- calculate mean
    double mean = 0.0;
    int valid_count = 0;
    
    for(int i = start_pos; i <= pos; i++)
    {
        if(i >= 0 && i < ArraySize(inter_array))
        {
            mean += inter_array[i];
            valid_count++;
        }
    }
    
    if(valid_count == 0)
        return(0.0001);
        
    mean /= valid_count;
    
    //--- calculate variance
    double variance = 0.0;
    for(int i = start_pos; i <= pos; i++)
    {
        if(i >= 0 && i < ArraySize(inter_array))
        {
            variance += MathPow(inter_array[i] - mean, 2);
        }
    }
    variance /= valid_count;
    
    double std_dev = MathSqrt(variance);
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–∏—à–∫–æ–º –º–∞–ª
    return(MathMax(std_dev, 0.0001));
}

//+------------------------------------------------------------------+
//| Expert deinitialization function                                |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
    // –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
    if(ShowInfoPanel)
    {
        DeleteInfoPanel();
    }
    
    // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –∑–æ–Ω
    ObjectDelete(0, overbought_zone_id);
    ObjectDelete(0, oversold_zone_id);
    ObjectDelete(0, overbought_line_id);
    ObjectDelete(0, oversold_line_id);
    
    string username = GetComputerUserName();
    string datetime_str = GetCurrentDateTime();
    
    Print(GetLocalizedText("indicator_finished"));
    Print(" ", GetLocalizedText("reason"), ": ", reason);
    Print(" ", GetLocalizedText("time"), ": ", datetime_str, " UTC");
    Print(" ", GetLocalizedText("user"), ": ", username);
}
